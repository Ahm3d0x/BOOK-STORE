// Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ù…Ø­Ø±Ø± Apps Script
const SHEET_ID = ''; // Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø­Ø§Ù„ÙŠ

function doGet(e) {
  const action = e.parameter.action;
  const db = getDb();
  let result = {};

  try {
    switch(action) {
      case 'getBooks':
        result = getData(db.books);
        break;
      case 'getSettings':
        const settingsArr = getData(db.settings);
        result = settingsArr.reduce((acc, curr) => {
          acc[curr.key] = curr.value;
          return acc;
        }, {});
        break;
      case 'getOrders':
         const orders = getData(db.orders);
         result = orders.reverse();
         break;
      case 'getSlider':
         result = getData(db.slider);
         break;
      default:
        result = { error: 'Invalid Action' };
    }
  } catch (err) {
    result = { error: err.toString() };
  }
  
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const action = e.parameter.action;
  const db = getDb();
  let result = {};
  
  try {
    const data = JSON.parse(e.postData.contents);
    
    switch(action) {
      // --- Ø§Ù„ÙƒØªØ¨ ---
      case 'addBook':
        data.id = data.id || new Date().getTime().toString();
        data.date_added = new Date().toLocaleDateString('en-GB');
        data.status = parseInt(data.stock) > 0 ? 'Ù…ØªÙˆÙØ±' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        addRow(db.books, data);
        result = { success: true, message: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨' };
        break;
        
      case 'updateBook':
        if(data.stock !== undefined) data.status = parseInt(data.stock) > 0 ? 'Ù…ØªÙˆÙØ±' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        updateRow(db.books, 'id', data.id, data);
        result = { success: true, message: 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«' };
        break;
        
      case 'deleteBook':
        deleteRow(db.books, 'id', data.id);
        result = { success: true, message: 'ØªÙ… Ø§Ù„Ø­Ø°Ù' };
        break;

// --- Ø§Ù„Ø·Ù„Ø¨Ø§Øª ---
      case 'placeOrder':
        // 1. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        data.order_id = 'ORD-' + Math.floor(100000 + Math.random() * 900000);
        data.date = new Date().toLocaleString('en-GB'); 
        data.status = 'Ø¬Ø¯ÙŠØ¯';
        data.date_preparing = ''; data.date_shipped = ''; data.date_delivered = ''; data.date_cancelled = '';

        // 2. Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        if (data.cartData) {
          const cartItems = JSON.parse(data.cartData);
          const booksSheet = db.books;
          const booksData = booksSheet.getDataRange().getValues();
          const headers = booksData[0];
          const idIndex = headers.indexOf('id');
          const stockIndex = headers.indexOf('stock');
          const statusIndex = headers.indexOf('status');

          cartItems.forEach(item => {
            for (let i = 1; i < booksData.length; i++) {
              if (String(booksData[i][idIndex]) === String(item.id)) {
                let currentStock = parseInt(booksData[i][stockIndex]);
                let newStock = currentStock - parseInt(item.qty);
                if (newStock < 0) newStock = 0;
                booksSheet.getRange(i + 1, stockIndex + 1).setValue(newStock);
                if (newStock === 0) {
                   booksSheet.getRange(i + 1, statusIndex + 1).setValue('ØºÙŠØ± Ù…ØªÙˆÙØ±');
                }
                break;
              }
            }
          });
        }

        // 3. Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø´ÙŠØª
        addRow(db.orders, data);

        // 4. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹)
        const settingsSheet = db.settings;
        let siteName = 'Book.com';
        let contactEmail = '';
        let supportPhone = '';

        try {
            // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹
            const allSettings = settingsSheet.getDataRange().getValues();
            allSettings.forEach(row => {
                if(String(row[0]) === 'site_name') siteName = row[1];
                if(String(row[0]) === 'whatsapp') supportPhone = row[1];
            });

            // Ù‚Ø±Ø§Ø¡Ø© Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ù† Ø§Ù„ØµÙ 4 Ø§Ù„Ø¹Ù…ÙˆØ¯ 2 Ù…Ø¨Ø§Ø´Ø±Ø©
            contactEmail = settingsSheet.getRange(4, 2).getValue().toString().trim();

        } catch (e) {
            console.log("Error reading settings: " + e.toString());
        }

        // 5. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ø·ÙˆØ± ÙÙŠ Ø§Ù„ÙÙˆØªØ±)
        const emailSubject = `ğŸ”” Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: ${data.order_id} - ${siteName}`;
        
        const createEmailBody = (isClient) => {
            const headerTitle = isClient ? 'ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨' : 'Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
            const greeting = isClient ? `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${data.customer_name}` : 'ØªÙ‚Ø±ÙŠØ± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©)';
            
            // Ù‚Ø³Ù… Ø®Ø§Øµ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
            let adminCustomerSection = '';
            if (!isClient) {
                adminCustomerSection = `
                <div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bbdefb;">
                    <h3 style="margin-top:0; color:#0d47a1; border-bottom: 1px solid #90caf9; padding-bottom: 5px;">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h3>
                    <table style="width: 100%; font-size: 14px;">
                        <tr><td style="font-weight:bold; width: 100px;">Ø§Ù„Ø§Ø³Ù…:</td><td>${data.customer_name}</td></tr>
                        <tr><td style="font-weight:bold;">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</td><td><a href="mailto:${data.email}">${data.email}</a></td></tr>
                        <tr><td style="font-weight:bold;">Ø§Ù„Ù‡Ø§ØªÙ:</td><td><a href="tel:${data.phone}">${data.phone}</a></td></tr>
                        <tr><td style="font-weight:bold;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</td><td>${data.address}</td></tr>
                    </table>
                </div>`;
            }

            return `
              <div dir="rtl" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; padding: 20px;">
                <div style="max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                  
                  <div style="background-color: #1a1a1a; color: #FFD700; padding: 20px; text-align: center;">
                    <h1 style="margin: 0;">${siteName}</h1>
                    <p style="margin: 5px 0 0; color: #aaa;">${headerTitle}</p>
                  </div>

                  <div style="padding: 20px;">
                    <h2 style="color: #333; text-align: center; margin-bottom: 20px;">${greeting}</h2>
                    
                    ${adminCustomerSection}

                    <div style="background-color: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px;">
                        <h3 style="margin-top:0; color:#d4af37; border-bottom: 1px dashed #ccc; padding-bottom: 10px;">ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (#${data.order_id})</h3>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;">
                          <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #eee; font-weight: bold; width: 30%;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${data.date}</td>
                          </tr>
                          <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #eee; font-weight: bold;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #eee; line-height: 1.6;">${data.items}</td>
                          </tr>
                          ${data.notes ? `
                          <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #eee; font-weight: bold;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #eee; color: #d63384;">${data.notes}</td>
                          </tr>` : ''}
                          <tr style="background-color: #fffbe6;">
                            <td style="padding: 15px 10px; font-weight: bold; font-size: 16px; color: #333;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</td>
                            <td style="padding: 15px 10px; font-weight: bold; font-size: 18px; color: #d32f2f;">${data.total_price}</td>
                          </tr>
                        </table>
                    </div>

                    ${isClient ? `
                    <div style="margin-top: 20px; text-align: center; font-size: 13px; color: #666;">
                       <p>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø³Ø¬Ù„: ${data.address}</p>
                       <p>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„: ${data.phone}</p>
                    </div>
                    <div style="margin-top: 20px; background-color: #f9f9f9; padding: 15px; border-radius: 5px; text-align: center; border: 1px solid #eee;">
                      <p style="margin: 0; color: #555; font-weight: bold;">Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§:</p>
                      <p style="margin: 5px 0;">ğŸ“§ ${contactEmail} ${supportPhone ? `| ğŸ“± ${supportPhone}` : ''}</p>
                    </div>
                    ` : ''}

                  </div>
                  
                  <div style="background-color: #333; color: #777; padding: 15px; text-align: center; font-size: 12px; border-top: 1px solid #444;">
                    <p style="margin: 0 0 5px 0;">&copy; ${new Date().getFullYear()} ${siteName}. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
                    
                    <p style="margin: 5px 0 0; font-size: 11px; color: #999; display: inline-block;">
                       Development by <a href="https://ahmed-attia-portfolio-git-main-ahm3d0xs-projects.vercel.app/" target="_blank" style="color: #FFD700; text-decoration: none; font-weight: bold; background-color: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">Ahmed M Attia ğŸ’»</a>
                    </p>
                  </div>

                </div>
              </div>
            `;
        };

        // 6. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
        try {
          // Ù„Ù„Ø¹Ù…ÙŠÙ„
          if(data.email && data.email.includes('@')) {
            MailApp.sendEmail({ to: data.email, subject: `âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ #${data.order_id}`, htmlBody: createEmailBody(true) });
          }
          
          // Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø´Ø§Ù…Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„)
          if(contactEmail && contactEmail.includes('@')) {
             MailApp.sendEmail({ to: contactEmail, subject: emailSubject, htmlBody: createEmailBody(false) });
          }
        } catch(e) {
          console.log("Email Error: " + e.toString()); 
        }

        result = { success: true, message: 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨', orderId: data.order_id };
        break;
     
      // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
      case 'updateSettings':
          const sSheet = db.settings;
          if (sSheet.getLastRow() > 1) sSheet.deleteRows(2, sSheet.getLastRow() - 1);
          for (const [key, value] of Object.entries(data)) {
             if(key !== 'action') sSheet.appendRow([key, value]);
          }
          result = { success: true, message: 'ØªÙ… Ø§Ù„Ø­ÙØ¸' };
          break;

      // --- Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ---
      case 'addSlider':
        data.id = new Date().getTime().toString();
        data.active = 'TRUE';
        addRow(db.slider, data);
        result = { success: true, message: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙŠØ­Ø©' };
        break;
      case 'updateSlider':
        updateRow(db.slider, 'id', data.id, data);
        result = { success: true, message: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ­Ø©' };
        break;
      case 'deleteSlider':
        deleteRow(db.slider, 'id', data.id);
        result = { success: true, message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙŠØ­Ø©' };
        break;

      default:
        result = { error: 'Invalid Action' };
    }
  } catch (err) {
    result = { error: err.toString() };
  }
  
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// Helpers
function getDb() {
  const ss = SHEET_ID ? SpreadsheetApp.openById(SHEET_ID) : SpreadsheetApp.getActiveSpreadsheet();
  return {
    books: ss.getSheetByName('Books'),
    orders: ss.getSheetByName('Orders'),
    settings: ss.getSheetByName('Settings'),
    slider: ss.getSheetByName('Slider')
  };
}

function getData(sheet) {
  const rows = sheet.getDataRange().getValues();
  if (rows.length === 0) return [];
  const headers = rows.shift();
  return rows.map(row => {
    let obj = {};
    headers.forEach((header, i) => obj[header] = row[i]);
    return obj;
  });
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© ØµÙ Ù…Ø­Ø³Ù†Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
function addRow(sheet, dataObj) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const row = headers.map(header => {
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù†Ø¶Ø¹Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¶Ø¹ Ù†Øµ ÙØ§Ø±Øº Ù„ØªØ¬Ù†Ø¨ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    return dataObj[header] !== undefined ? dataObj[header] : '';
  });
  sheet.appendRow(row);
}

function updateRow(sheet, idColName, idValue, dataObj) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const data = sheet.getDataRange().getValues();
  const idIndex = headers.indexOf(idColName);
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][idIndex]) === String(idValue)) {
      headers.forEach((header, colIndex) => {
        if (dataObj.hasOwnProperty(header)) sheet.getRange(i + 1, colIndex + 1).setValue(dataObj[header]);
      });
      return;
    }
  }
}

function deleteRow(sheet, idColName, idValue) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const data = sheet.getDataRange().getValues();
  const idIndex = headers.indexOf(idColName);
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][idIndex]) === String(idValue)) {
      sheet.deleteRow(i + 1);
      return;
    }
  }
}



function authorizeEmail() {
  MailApp.getRemainingDailyQuota();
  console.log("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­!");
}